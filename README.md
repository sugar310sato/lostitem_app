# lostitem_app

## アプリの概要

拾得物の管理を行うアプリです。

### 主な機能

- **従来の固定フォーム登録**: 標準的な拾得物情報の登録
- **フリーフロー形式登録**: カスタム項目を自由に追加・編集できる柔軟な登録方式
  - 動的フィールドの追加・削除
  - テンプレートの保存・読み込み
  - 様々なフィールドタイプ（テキスト、テキストエリア、数値、日付、選択肢、ラジオボタン、チェックボックス）

## セットアップ方法

### 仮想環境の作成

以下のコマンドで任意の仮想環境を作成し、ライブラリのインストールを行います。
python3.11以下で動作
```
python -m venv   任意の名前
.\仮想環境名\Scripts\activate
pip install -r requirements.txt
```

### config.py の作成

apps 直下に config.py というファイルを作成し、config.sample の内容をコピーします。  
シークレットキー、CSRF のシークレットキーの内容を任意の 20 桁の英数字に変更してください。
また、6 行目の LAMBDA_ENDPOINT に lambda への URL を張り付けてください。

### .env の作成

lost_item 直下に、.env というファイルを作成してください。ファイルの中身は、次の通りです。

```
FLASK_APP=apps.app:create_app("local")
FLASK_ENV=test
```

### データベース構築場所の選択

初期値では、DB を lostitem_app 直下に製作するようになっています。これを変更するために、

### AI推論機能の設定

#### YOLOローカル推論（推奨）
アプリはYOLO v8を使用したローカル推論機能を搭載しています。初回実行時に自動的にYOLOモデルがダウンロードされます。

**必要な依存関係:**
- ultralytics==8.1.28（requirements.txtに含まれています）

**カスタムモデルの使用:**
カスタムトレーニングしたYOLOモデルを使用する場合は、`apps/register/model_folder/yolo_model.pt`として保存してください。

#### CoCa画像キャプション生成（オプション）
img2txt のモデルである Coca を利用します。register/model_folder 直下に model.pth として保存してください。

#### YOLOモデルのテスト
YOLOモデルの動作確認は以下のコマンドで実行できます：
```bash
cd apps/register/model_folder
python test_yolo.py [テスト画像のパス]
```

### DB の作成

以下のコマンドを入力し、DB を作成してください。

```
flask db migrate
flaks db upgrade
```

DB を初期化したい場合は、以下のコマンドを入力してください。

```
flask db downgrade
flask db upgrade
```

DB の作成がうまくいかない場合、migrations フォルダを削除して、以下のコマンドを入力してください。

```
flask db init
flask db migrate
flask db upgrade
```

### アプリの実行

以下のコマンドでアプリを実行してください。

```
flask run
```

## フリーフロー形式登録の使用方法

1. 拾得者選択画面で「フリーフロー形式で登録」ボタンをクリック
2. 基本情報（拾得日時、受付日時、受付担当者）を入力
3. 「項目を追加」ボタンでカスタムフィールドを追加
4. 各フィールドの項目名、タイプ、値、必須設定を入力
5. 「テンプレートを保存」で現在の設定を保存可能
6. 「テンプレートを読み込み」で保存した設定を復元可能
7. 「登録」ボタンで拾得物を登録

### フリーフロー形式の改善点

#### 自動フォーカス機能
- ページ読み込み時に拾得日フィールドに自動フォーカス
- 拾得日入力後、自動的に拾得時間フィールドにフォーカス移動
- 拾得時間入力後、自動的に物品の特徴フィールドにフォーカス移動
- 物品の特徴入力後、自動的に拾得場所フィールドにフォーカス移動
- 拾得場所入力後、自動的に拾得者氏名フィールドにフォーカス移動
- 拾得者氏名入力後、自動的に郵便番号フィールドにフォーカス移動

#### 自動入力機能
- 受付日時は現在の日付・時刻で自動入力（修正可能）
- 拾得時間は現在時刻で初期設定（修正可能）
- AI認識結果があれば物品の特徴欄に自動入力

#### 効率的な入力フロー
1. **拾得日** → 自動的に拾得時間に移動
2. **拾得時間** → 自動的に物品の特徴に移動
3. **物品の特徴** → AI認識結果を自動入力、手動修正可能
4. **拾得場所** → 自動的に拾得者氏名に移動
5. **拾得者氏名** → 自動的に郵便番号に移動
6. **任意項目** → 郵便番号、住所、連絡先（任意入力）

#### 削除された項目
- 年齢項目（不要なため削除）
- 性別項目（不要なため削除）
- その他の不要な項目を整理

#### マウスクリック削減
- タブキーでの自然な移動
- 自動フォーカスによる効率的な入力
- プルダウンでの時間選択（マウス操作最小化）
- キーボード中心の操作で高速入力が可能

#### Enterキーでの移動機能
- 各フィールドでEnterキーを押すと自動的に次のフィールドに移動
- 移動順序: 拾得日 → 拾得時間 → 物品の特徴 → 分類（大中小） → 備考 → 拾得場所 → 拾得者氏名 → 郵便番号 → 住所 → 連絡先
- マウスを使わずにキーボードだけで高速入力が可能

#### 写真表示機能
- 拾得物情報欄の右側に撮影した物品の写真を表示
- 写真サイズは自動調整（最大200x200px）
- 写真がない場合は自動的に非表示

#### AI分類機能
- AI認識結果に基づいて分類プルダウンに自動設定
- 対応する分類:
  - 現金関連 → 現金
  - カード関連 → 証明書類・カード類
  - 携帯電話関連 → 携帯電話・スマートフォン
  - 鍵関連 → 鍵類
  - 鞄・バッグ関連 → 鞄・バッグ類
  - 衣類関連 → 衣類
  - 書籍関連 → 書籍・雑誌類
  - 傘関連 → 傘類
  - 眼鏡関連 → 眼鏡・サングラス類
  - 時計関連 → 時計類
  - ジュエリー関連 → ジュエリー・アクセサリー類
  - 玩具関連 → 玩具類
  - スポーツ用品関連 → スポーツ用品類
  - 化粧品関連 → 化粧品類
  - 食品関連 → 食品類
  - 医薬品関連 → 医薬品類
  - 電子機器関連 → 電子機器類
  - その他 → その他の物品
