# 拾得物管理システム - インストーラー作成手順

## 概要

このドキュメントでは、Inno Setupを使用して拾得物管理システムのWindowsインストーラーを作成する手順を説明します。

## 必要なソフトウェア

### 1. Inno Setup のインストール

1. **Inno Setup をダウンロード**
   - 公式サイト: https://jrsoftware.org/isdl.php
   - 最新バージョン（6.3以降）をダウンロード

2. **Inno Setup をインストール**
   - ダウンロードしたインストーラーを実行
   - デフォルト設定でインストール（日本語サポートも含まれる）

3. **日本語パックの確認**
   - Inno Setup を起動
   - 「Languages」フォルダに「Japanese.isl」が含まれていることを確認

## ビルド準備

### 1. PyInstallerで再ビルド

現在のflet_app.exeが適切にビルドされていることを確認します。

```powershell
# 仮想環境をアクティベート
.\venv\Scripts\activate

# PyInstallerでビルド
pyinstaller flet_app.spec
```

### 2. ファイル構成の確認

以下の構造になっていることを確認してください：

```
lostitem_app/
├── dist/
│   └── flet_app.exe
├── flet_pages/
│   └── (すべてのPythonモジュール)
├── data/
│   └── (ディレクトリ構造)
├── yolov8x_seg_custom.pt
├── yolo11x_seg_custom.pt
├── yolov8n.pt
├── item_classification.json
├── lostitem.db
└── installer.iss
```

## インストーラーの作成

### 方法1: Inno Setupコンパイラーを使用（GUI）

1. **Inno Setupコンパイラーを起動**
   - スタートメニューから「Inno Setup Compiler」を起動

2. **スクリプトを開く**
   - File → Open
   - `installer.iss` を選択

3. **ビルド実行**
   - Build → Compile
   - または `Ctrl+F9`
   - ビルドが完了すると `installer/拾得物管理システム_Setup_1.0.0.exe` が生成されます

### 方法2: コマンドラインから実行

```powershell
# Inno Setupのパスを通した後
iscc installer.iss
```

## インストーラーの動作確認

### テスト環境での確認項目

1. **インストール**
   - インストール先の指定が可能か
   - スタートメニューフォルダーの指定が可能か
   - デスクトップショートカットの作成ができるか

2. **アプリケーション起動**
   - インストール後にアプリが正常に起動するか
   - データディレクトリが正しい場所に作成されているか
   - データベースの初期化が正常に行われるか

3. **アンインストール**
   - アンインストールが正常に実行できるか
   - データファイルが適切に処理されるか（削除/保持）

## インストーラーのカスタマイズ

### ショートカットの追加/削除

`installer.iss` の `[Tasks]` セクションを編集：

```iss
[Tasks]
Name: "desktopicon"; Description: "デスクトップにショートカットを作成"; GroupDescription: "追加アイコン"
Name: "quicklaunchicon"; Description: "クイック起動にショートカットを作成"; GroupDescription: "追加アイコン"; Flags: unchecked
```

### インストール先の変更

`[Setup]` セクションの `DefaultDirName` を変更：

```iss
DefaultDirName={pf}\{#MyAppName}  ; Program Files
DefaultDirName={localappdata}\{#MyAppName}  ; ユーザーデータ
DefaultDirName={code:GetDataDir}  ; カスタムフォルダ
```

### データ保存先のカスタマイズ

データは `{commonappdata}` （通常は `C:\ProgramData`）に保存されます。
これをユーザーのAppDataに変更する場合は、以下のように修正：

```iss
; dataディレクトリのパスを変更
Source: "data\database\*"; DestDir: "{localappdata}\{#MyAppName}\data\database"
```

## トラブルシューティング

### 問題1: アプリが起動しない

**原因**: PyInstallerで適切にすべての依存関係が含まれていない

**対応**:
1. `flet_app.spec` を更新してhiddenimportsを追加
2. 必要に応じてビルドオプションを調整

### 問題2: データファイルが見つからない

**原因**: アプリケーションがハードコードされたパスを使用している

**対応**:
1. アプリケーションコードでパスの解決方法を確認
2. `data/config/paths.py` の設定を確認

### 問題3: YOLOモデルが見つからない

**原因**: モデルファイルがインストール先に含まれていない

**対応**:
1. `installer.iss` の `[Files]` セクションを確認
2. モデルファイルが `{app}` にインストールされているか確認

## 配布方法

### セルフ実行インストーラー

完成したインストーラー（`拾得物管理システム_Setup_1.0.0.exe`）を配布します。

### デジタル署名（推奨）

本番環境で使用する場合は、インストーラーにデジタル署名を追加してください。

```powershell
# コード署名証明書で署名
signtool sign /f "証明書.pfx" /p "パスワード" "installer/拾得物管理システム_Setup_1.0.0.exe"
```

## 次のステップ

1. **バージョン管理**: `{#MyAppVersion}` を更新
2. **アイコンの追加**: カスタムアイコンを作成
3. **自動更新機能**: 将来的に自動更新機能を実装
4. **多言語サポート**: 追加の言語サポートを追加

## 関連ファイル

- `installer.iss` - Inno Setupスクリプト
- `flet_app.spec` - PyInstaller設定ファイル
- `アプリケーション構成.md` - ファイル構成の詳細

