{% extends "register/base.html" %}
{% block title %}フリーフロー拾得物登録{% endblock %}
{% block content %}
<div class="block-card">
    <h2>フリーフロー拾得物情報登録</h2>
    <form action="{{ url_for('register.freeflow_register_item', choice_finder=choice_finder, use_AI=use_AI) }}"
        method="post">
        {{ form.csrf_token }}
        <div class="container">
            <!-- 基本情報セクション -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>基本情報</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">管理番号：{{ main_id }}</div>
                        <div class="col-6">{{ form.notify.label }} {{ form.notify }}</div>
                    </div>

                    <!-- 拾得日時 -->
                    <div class="row mb-3">
                        <div class="col-4">
                            <label for="{{ form.get_item.id }}">{{ form.get_item.label }}</label>
                            {{ form.get_item(class="form-control", id="get_item") }}
                        </div>
                        <div class="col-4">
                            <label>拾得時間</label>
                            <div class="d-flex">
                                <select id="get_item_hour" name="get_item_hour" class="form-control"
                                    style="width: 60px;">
                                    {% for i in range(24) %}
                                    <option value="{{ i }}">{{ i }}</option>
                                    {% endfor %}
                                </select>
                                <span class="mx-2 align-self-center">:</span>
                                <select id="get_item_minute" name="get_item_minute" class="form-control"
                                    style="width: 60px;">
                                    {% for i in range(60) %}
                                    <option value="{{ i }}">{{ i }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 受付日時（自動入力） -->
                    <div class="row mb-3">
                        <div class="col-4">
                            <label for="{{ form.recep_item.id }}">{{ form.recep_item.label }}</label>
                            {{ form.recep_item(class="form-control", id="recep_item") }}
                        </div>
                        <div class="col-4">
                            <label>受付時間</label>
                            <div class="d-flex">
                                <select id="recep_item_hour" name="recep_item_hour" class="form-control"
                                    style="width: 60px;">
                                    {% for i in range(24) %}
                                    <option value="{{ i }}">{{ i }}</option>
                                    {% endfor %}
                                </select>
                                <span class="mx-2 align-self-center">:</span>
                                <select id="recep_item_minute" name="recep_item_minute" class="form-control"
                                    style="width: 60px;">
                                    {% for i in range(60) %}
                                    <option value="{{ i }}">{{ i }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-4">
                            <label for="{{ form.recep_manager.id }}">{{ form.recep_manager.label }}</label>
                            {{ form.recep_manager(class="form-control", id="recep_manager") }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 拾得物情報セクション -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>拾得物情報</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-8">
                            <label for="{{ form.item_feature.id }}">{{ form.item_feature.label }}</label>
                            {{ form.item_feature(class="form-control", rows="3", id="item_feature", placeholder="AI認識結果:
                            " + (inferenceResult or "")) }}
                        </div>
                        <div class="col-4">
                            <div class="mb-3">
                                {{ form.item_value.label }} {{ form.item_value(class="form-check-input") }}
                            </div>
                            <!-- 物品写真の表示 -->
                            <div class="text-center">
                                <img src="{{ url_for('register.image_file', filename='captured_image.jpg') }}"
                                    alt="拾得物の写真" class="img-fluid border rounded"
                                    style="max-width: 200px; max-height: 200px;" onerror="this.style.display='none'">
                            </div>
                        </div>
                    </div>

                    <!-- 分類プルダウン -->
                    <div class="row mb-3">
                        <div class="col-4">
                            <label>物件分類（大）</label>
                            <select name="item_class_L" id="item_class_L" class="form-control">
                                {% for option in ITEM_CLASS_L %}
                                <option value="{{ option }}" {% if option==result %}selected{% endif %}>{{ option }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-4">
                            <label>（中）</label>
                            <select name="item_class_M" id="item_class_M" class="form-control">
                                {% for option in ITEM_CLASS_M %}
                                <option value="{{ option['value'] }}" data-val="{{ option['data-val'] }}">{{
                                    option['value'] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-4">
                            <label>（小）</label>
                            <select name="item_class_S" id="item_class_S" class="form-control">
                                {% for option in ITEM_CLASS_S %}
                                <option value="{{ option['value'] }}" data-val="{{ option['data-val'] }}">{{
                                    option['value'] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="{{ form.item_remarks.id }}">{{ form.item_remarks.label }}</label>
                            {{ form.item_remarks(class="form-control", rows="2", id="item_remarks",
                            placeholder="その他の特徴を記入してください") }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 拾得場所・拾得者情報セクション -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>拾得場所・拾得者情報</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="{{ form.find_area.id }}">{{ form.find_area.label }}</label>
                            {{ form.find_area(class="form-control", id="find_area") }}
                        </div>
                        <div class="col-6">
                            <label for="{{ form.finder_name.id }}">{{ form.finder_name.label }}</label>
                            {{ form.finder_name(class="form-control", id="finder_name") }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-3">
                            <label for="{{ form.finder_post.id }}">{{ form.finder_post.label }}</label>
                            {{ form.finder_post(class="form-control", id="finder_post") }}
                        </div>
                        <div class="col-9">
                            <label for="{{ form.finder_address.id }}">{{ form.finder_address.label }}</label>
                            {{ form.finder_address(class="form-control", id="finder_address") }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="{{ form.finder_tel1.id }}">{{ form.finder_tel1.label }}</label>
                            {{ form.finder_tel1(class="form-control", id="finder_tel1") }}
                        </div>
                        <div class="col-6">
                            <label for="{{ form.finder_tel2.id }}">{{ form.finder_tel2.label }}</label>
                            {{ form.finder_tel2(class="form-control", id="finder_tel2") }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 動的フィールドセクション -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>カスタム項目</h4>
                    <div>
                        {{ form.add_field(class="btn btn-success btn-sm") }}
                        {{ form.remove_field(class="btn btn-danger btn-sm") }}
                    </div>
                </div>
                <div class="card-body">
                    <div id="dynamic-fields-container">
                        {% for field_form in form.dynamic_fields %}
                        <div class="dynamic-field-row border rounded p-3 mb-3">
                            <div class="row">
                                <div class="col-md-3">
                                    {{ field_form.field_name.label }}
                                    {{ field_form.field_name(class="form-control") }}
                                </div>
                                <div class="col-md-2">
                                    {{ field_form.field_type.label }}
                                    {{ field_form.field_type(class="form-control") }}
                                </div>
                                <div class="col-md-4">
                                    {{ field_form.field_value.label }}
                                    {{ field_form.field_value(class="form-control", rows="2") }}
                                </div>
                                <div class="col-md-2">
                                    {{ field_form.required.label }}
                                    {{ field_form.required(class="form-check-input") }}
                                </div>
                                <div class="col-md-1">
                                    <button type="button"
                                        class="btn btn-outline-danger btn-sm remove-field-btn">削除</button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- テンプレート管理セクション -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>テンプレート管理</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            {{ form.save_template(class="btn btn-info") }}
                        </div>
                        <div class="col-md-6">
                            {{ form.load_template(class="btn btn-warning") }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 登録ボタン -->
            <div class="text-center">
                {{ form.submit(class="btn btn-primary btn-lg") }}
            </div>
        </div>
    </form>
</div>

<!-- JavaScript for dynamic field management and auto-focus -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const container = document.getElementById('dynamic-fields-container');
        const addFieldBtn = document.querySelector('input[name="add_field"]');
        const removeFieldBtn = document.querySelector('input[name="remove_field"]');

        // 現在時刻を設定
        var now = new Date();
        var currentHour = now.getHours();
        var currentMinute = now.getMinutes();
        var currentDate = now.toISOString().split('T')[0];

        // 受付日時を現在時刻に自動設定
        document.getElementById('recep_item').value = currentDate;
        document.getElementById('recep_item_hour').value = currentHour;
        document.getElementById('recep_item_minute').value = currentMinute;

        // 拾得時間を現在時刻に設定（修正可能）
        document.getElementById('get_item_hour').value = currentHour;
        document.getElementById('get_item_minute').value = currentMinute;

        // 拾得日に自動フォーカス
        document.getElementById('get_item').focus();

        // Enterキーで次のフィールドに移動する関数
        function setupEnterKeyNavigation() {
            const fields = [
                'get_item',
                'get_item_hour',
                'get_item_minute',
                'item_feature',
                'item_class_L',
                'item_class_M',
                'item_class_S',
                'item_remarks',
                'find_area',
                'finder_name',
                'finder_post',
                'finder_address',
                'finder_tel1',
                'finder_tel2'
            ];

            fields.forEach((fieldId, index) => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const nextField = document.getElementById(fields[index + 1]);
                            if (nextField) {
                                nextField.focus();
                            }
                        }
                    });
                }
            });
        }

        // Enterキーナビゲーションを設定
        setupEnterKeyNavigation();

        // 拾得日入力後に拾得時間に自動フォーカス
        document.getElementById('get_item').addEventListener('change', function () {
            document.getElementById('get_item_hour').focus();
        });

        // 拾得時間入力後に物品の特徴に自動フォーカス
        document.getElementById('get_item_minute').addEventListener('change', function () {
            document.getElementById('item_feature').focus();
        });

        // 物品の特徴入力後に拾得場所に自動フォーカス
        document.getElementById('item_feature').addEventListener('blur', function () {
            if (this.value.trim()) {
                document.getElementById('find_area').focus();
            }
        });

        // 拾得場所入力後に拾得者氏名に自動フォーカス
        document.getElementById('find_area').addEventListener('blur', function () {
            if (this.value.trim()) {
                document.getElementById('finder_name').focus();
            }
        });

        // 拾得者氏名入力後に郵便番号に自動フォーカス
        document.getElementById('finder_name').addEventListener('blur', function () {
            if (this.value.trim()) {
                document.getElementById('finder_post').focus();
            }
        });

        // AI認識結果を分類プルダウンに先行入力
        function setAIClassification() {
            var aiResult = "{{ inferenceResult }}";
            if (aiResult && aiResult !== "None" && aiResult !== "") {
                // 大分類の設定
                var largeClassSelect = document.getElementById('item_class_L');
                var mediumClassSelect = document.getElementById('item_class_M');
                var smallClassSelect = document.getElementById('item_class_S');

                // AI結果に基づいて分類を設定
                if (aiResult.includes('現金') || aiResult.includes('お金') || aiResult.includes('金')) {
                    largeClassSelect.value = '現金';
                    // 中分類と小分類も設定
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('カード') || aiResult.includes('クレジット') || aiResult.includes('デビット')) {
                    largeClassSelect.value = '証明書類・カード類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('携帯') || aiResult.includes('スマホ') || aiResult.includes('電話')) {
                    largeClassSelect.value = '携帯電話・スマートフォン';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('鍵') || aiResult.includes('キー')) {
                    largeClassSelect.value = '鍵類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('鞄') || aiResult.includes('バッグ') || aiResult.includes('かばん')) {
                    largeClassSelect.value = '鞄・バッグ類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('服') || aiResult.includes('衣類') || aiResult.includes('シャツ') || aiResult.includes('ズボン')) {
                    largeClassSelect.value = '衣類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('本') || aiResult.includes('書籍') || aiResult.includes('雑誌')) {
                    largeClassSelect.value = '書籍・雑誌類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('傘') || aiResult.includes('かさ')) {
                    largeClassSelect.value = '傘類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('眼鏡') || aiResult.includes('メガネ')) {
                    largeClassSelect.value = '眼鏡・サングラス類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('時計') || aiResult.includes('腕時計')) {
                    largeClassSelect.value = '時計類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('ジュエリー') || aiResult.includes('アクセサリー') || aiResult.includes('指輪') || aiResult.includes('ネックレス')) {
                    largeClassSelect.value = 'ジュエリー・アクセサリー類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('玩具') || aiResult.includes('おもちゃ')) {
                    largeClassSelect.value = '玩具類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('スポーツ') || aiResult.includes('運動')) {
                    largeClassSelect.value = 'スポーツ用品類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('化粧品') || aiResult.includes('コスメ')) {
                    largeClassSelect.value = '化粧品類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('食品') || aiResult.includes('食べ物') || aiResult.includes('飲み物')) {
                    largeClassSelect.value = '食品類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('薬') || aiResult.includes('医薬品')) {
                    largeClassSelect.value = '医薬品類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('電子機器') || aiResult.includes('パソコン') || aiResult.includes('タブレット')) {
                    largeClassSelect.value = '電子機器類';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                } else if (aiResult.includes('その他') || aiResult.includes('その他の物品')) {
                    largeClassSelect.value = 'その他の物品';
                    if (mediumClassSelect.options.length > 0) {
                        mediumClassSelect.value = mediumClassSelect.options[0].value;
                    }
                    if (smallClassSelect.options.length > 0) {
                        smallClassSelect.value = smallClassSelect.options[0].value;
                    }
                }
            }
        }

        // AI分類を設定
        setAIClassification();

        // 項目を追加
        addFieldBtn.addEventListener('click', function (e) {
            e.preventDefault();
            addDynamicField();
        });

        // 項目を削除
        removeFieldBtn.addEventListener('click', function (e) {
            e.preventDefault();
            removeLastField();
        });

        // 個別削除ボタンのイベント
        container.addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-field-btn')) {
                e.target.closest('.dynamic-field-row').remove();
            }
        });

        function addDynamicField() {
            const fieldCount = container.children.length;
            const newField = document.createElement('div');
            newField.className = 'dynamic-field-row border rounded p-3 mb-3';
            newField.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <label>項目名</label>
                    <input type="text" name="dynamic_fields-${fieldCount}-field_name" class="form-control" required>
                </div>
                <div class="col-md-2">
                    <label>フィールドタイプ</label>
                    <select name="dynamic_fields-${fieldCount}-field_type" class="form-control" required>
                        <option value="text">テキスト</option>
                        <option value="textarea">テキストエリア</option>
                        <option value="number">数値</option>
                        <option value="date">日付</option>
                        <option value="select">選択肢</option>
                        <option value="radio">ラジオボタン</option>
                        <option value="checkbox">チェックボックス</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label>値/選択肢（改行区切り）</label>
                    <textarea name="dynamic_fields-${fieldCount}-field_value" class="form-control" rows="2"></textarea>
                </div>
                <div class="col-md-2">
                    <label>必須項目</label>
                    <input type="checkbox" name="dynamic_fields-${fieldCount}-required" class="form-check-input">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-field-btn">削除</button>
                </div>
            </div>
        `;
            container.appendChild(newField);
        }

        function removeLastField() {
            const fields = container.querySelectorAll('.dynamic-field-row');
            if (fields.length > 1) {
                fields[fields.length - 1].remove();
            }
        }

        // AI認識結果があれば物品の特徴欄に自動入力
        var aiResult = "{{ inferenceResult }}";
        if (aiResult && aiResult !== "None" && aiResult !== "") {
            var featureField = document.getElementById('item_feature');
            if (featureField.value === "") {
                featureField.value = aiResult;
            }
        }
    });
</script>

<style>
    .dynamic-field-row {
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }

    .dynamic-field-row:hover {
        background-color: #e9ecef;
    }

    .card-header {
        background-color: #007bff;
        color: white;
    }

    .btn-sm {
        font-size: 0.875rem;
    }

    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    /* 自動フォーカス時のハイライト */
    .form-control:focus {
        background-color: #fff3cd;
    }
</style>
{% endblock %}